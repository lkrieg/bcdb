#!/bin/bash

# Very basic build configuration script
# but it does the job at least for now.
# Requires ldconfig for library checks.

SRC="etc/config.h.in"
DST="src/config.h"

main()
{
	local use_debug="no"
	local use_pthread="no"
	local use_zlib="no"

	# Make sure the config header source file exists
	test -f "${SRC}" || error "Header '${SRC}' missing."

	# Prompt user to enable debug mode
	prompt "Enable debug mode?" && use_debug="yes"

	# Check linker searchpaths for libraries
	exists "libpthread" && use_pthread="yes"
	exists "libz"       && use_zlib="yes"

	info "Checking for debug...${use_debug}"
	info "Checking for pthread...${use_pthread}"
	info "Checking for zlib...${use_zlib}"

	# Process input file
	cp "${SRC}" "${DST}"

	define "DEBUG"         "${use_debug}"
	define "HAVE_PTHREAD"  "${use_pthread}"
	define "HAVE_ZLIB"     "${use_zlib}"

	printf "Configuration finished.\n"

	return 0
}

exists()
{
	ldconfig -p | grep "${1}\.so" >/dev/null
	return ${?}
}

define()
{
	case "${2}" in
	yes) sed -i "s/undef ${1}/define ${1}/g" "${DST}" ;;
	*)   sed -i "s/define ${1}/undef ${1}/g" "${DST}" ;;
	esac
}

prompt()
{
	read -p "${1} [y/N] " ch
	case "${ch}" in
	y|Y) return 0 ;;
	*)   return 1 ;;
	esac
}

error()
{
	info "Error: ${1}"
	exit 1
}

info()
{
	printf "${1}\n"
}

main $@
